<!DOCTYPE html>
<html lang="en-US">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>位运算简介及实用技巧（二）：进阶篇(1) | Matrix67: The Aha Moments</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://www.matrix67.com/blog/xmlrpc.php">
	<script src="http://www.matrix67.com/blog/wp-content/themes/matrix67/js/jquery-2.1.0.min.js"></script>
	<script src="http://www.matrix67.com/blog/wp-content/themes/matrix67/js/old-theme.js"
		type="text/javascript"></script>
	<link rel="stylesheet" href="http://www.matrix67.com/blog/wp-content/themes/matrix67/css/old-theme.css"
		type="text/css" media="all">
	<link rel='dns-prefetch' href='//s.w.org' />
	<link rel="alternate" type="application/rss+xml" title="Matrix67: The Aha Moments &raquo; Feed"
		href="http://www.matrix67.com/blog/feed" />
	<link rel="alternate" type="application/rss+xml" title="Matrix67: The Aha Moments &raquo; Comments Feed"
		href="http://www.matrix67.com/blog/comments/feed" />
	<link rel="alternate" type="application/rss+xml"
		title="Matrix67: The Aha Moments &raquo; 位运算简介及实用技巧（二）：进阶篇(1) Comments Feed"
		href="http://www.matrix67.com/blog/archives/264/feed" />
	<script type="text/javascript">
		window._wpemojiSettings = { "baseUrl": "https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/", "ext": ".png", "svgUrl": "https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/", "svgExt": ".svg", "source": { "concatemoji": "http:\/\/www.matrix67.com\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.23" } };
		!function (e, o, t) { var a, n, r; function i(e) { var t = o.createElement("script"); t.src = e, t.type = "text/javascript", o.getElementsByTagName("head")[0].appendChild(t) } for (r = Array("simple", "flag", "unicode8", "diversity", "unicode9"), t.supports = { everything: !0, everythingExceptFlag: !0 }, n = 0; n < r.length; n++)t.supports[r[n]] = function (e) { var t, a, n = o.createElement("canvas"), r = n.getContext && n.getContext("2d"), i = String.fromCharCode; if (!r || !r.fillText) return !1; switch (r.textBaseline = "top", r.font = "600 32px Arial", e) { case "flag": return (r.fillText(i(55356, 56806, 55356, 56826), 0, 0), n.toDataURL().length < 3e3) ? !1 : (r.clearRect(0, 0, n.width, n.height), r.fillText(i(55356, 57331, 65039, 8205, 55356, 57096), 0, 0), a = n.toDataURL(), r.clearRect(0, 0, n.width, n.height), r.fillText(i(55356, 57331, 55356, 57096), 0, 0), a !== n.toDataURL()); case "diversity": return r.fillText(i(55356, 57221), 0, 0), a = (t = r.getImageData(16, 16, 1, 1).data)[0] + "," + t[1] + "," + t[2] + "," + t[3], r.fillText(i(55356, 57221, 55356, 57343), 0, 0), a != (t = r.getImageData(16, 16, 1, 1).data)[0] + "," + t[1] + "," + t[2] + "," + t[3]; case "simple": return r.fillText(i(55357, 56835), 0, 0), 0 !== r.getImageData(16, 16, 1, 1).data[0]; case "unicode8": return r.fillText(i(55356, 57135), 0, 0), 0 !== r.getImageData(16, 16, 1, 1).data[0]; case "unicode9": return r.fillText(i(55358, 56631), 0, 0), 0 !== r.getImageData(16, 16, 1, 1).data[0] }return !1 }(r[n]), t.supports.everything = t.supports.everything && t.supports[r[n]], "flag" !== r[n] && (t.supports.everythingExceptFlag = t.supports.everythingExceptFlag && t.supports[r[n]]); t.supports.everythingExceptFlag = t.supports.everythingExceptFlag && !t.supports.flag, t.DOMReady = !1, t.readyCallback = function () { t.DOMReady = !0 }, t.supports.everything || (a = function () { t.readyCallback() }, o.addEventListener ? (o.addEventListener("DOMContentLoaded", a, !1), e.addEventListener("load", a, !1)) : (e.attachEvent("onload", a), o.attachEvent("onreadystatechange", function () { "complete" === o.readyState && t.readyCallback() })), (a = t.source || {}).concatemoji ? i(a.concatemoji) : a.wpemoji && a.twemoji && (i(a.twemoji), i(a.wpemoji))) }(window, document, window._wpemojiSettings);
	</script>
	<style type="text/css">
		img.wp-smiley,
		img.emoji {
			display: inline !important;
			border: none !important;
			box-shadow: none !important;
			height: 1em !important;
			width: 1em !important;
			margin: 0 .07em !important;
			vertical-align: -0.1em !important;
			background: none !important;
			padding: 0 !important;
		}
	</style>
	<link rel='stylesheet' id='matrix67-style-css'
		href='http://www.matrix67.com/blog/wp-content/themes/matrix67/style.css?ver=4.6.23' type='text/css'
		media='all' />
	<link rel='https://api.w.org/' href='http://www.matrix67.com/blog/wp-json/' />
	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.matrix67.com/blog/xmlrpc.php?rsd" />
	<link rel="wlwmanifest" type="application/wlwmanifest+xml"
		href="http://www.matrix67.com/blog/wp-includes/wlwmanifest.xml" />
	<link rel='prev' title='位运算简介及实用技巧（一）：基础篇' href='http://www.matrix67.com/blog/archives/263' />
	<link rel='next' title='位运算简介及实用技巧（三）：进阶篇(2)' href='http://www.matrix67.com/blog/archives/266' />
	<meta name="generator" content="WordPress 4.6.23" />
	<link rel="canonical" href="http://www.matrix67.com/blog/archives/264" />
	<link rel='shortlink' href='http://www.matrix67.com/blog/?p=264' />
	<link rel="alternate" type="application/json+oembed"
		href="http://www.matrix67.com/blog/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fwww.matrix67.com%2Fblog%2Farchives%2F264" />
	<link rel="alternate" type="text/xml+oembed"
		href="http://www.matrix67.com/blog/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fwww.matrix67.com%2Fblog%2Farchives%2F264&#038;format=xml" />
</head>

<body class="single single-post postid-264 single-format-standard">
	<div id="page" class="hfeed site">

		<header id="masthead" class="site-header" role="banner">
			<div class="site-branding">
				<h1 class="site-title"><a href="http://www.matrix67.com/blog/" rel="home">Matrix67: The Aha Moments</a>
				</h1>
			</div>
			<aside id="search" class="widget_search">
				<form role="search" method="get" class="search-form" action="http://www.matrix67.com/blog/">
					<label>
						<span class="screen-reader-text"></span>
						<input type="search" class="search-field" value="" name="s" title="" />
					</label>
					<input type="submit" class="search-submit" value="&#59393;" />
				</form>
			</aside>
		</header><!-- #masthead -->

		<div id="content" class="site-content">

			<div id="primary" class="content-area">
				<main id="main" class="site-main" role="main">



					<aside id="notice">这是一篇旧文，点击<a id="theme-toggle">此处</a>以旧主题模式浏览。</aside>
					<article id="post-264"
						class="post-264 post type-post status-publish format-standard hentry category-uncategorized tag-c tag-pascal tag-405 tag-409 tag-412 tag-333 tag-242 tag-274 tag-281">
						<header class="entry-header">
							<h1 class="entry-title">位运算简介及实用技巧（二）：进阶篇(1)</h1>
						</header><!-- .entry-header -->

						<div class="entry-content">
							<p>=====&nbsp;&nbsp; 真正强的东西来了！&nbsp;&nbsp; =====</p>
							<p><strong>二进制中的1有奇数个还是偶数个</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;我们可以用下面的代码来计算一个32位整数的二进制中1的个数的奇偶性，当输入数据的二进制表示里有偶数个数字1时程序输出0，有奇数个则输出1。例如，1314520的二进制101000000111011011000中有9个1，则x=1314520时程序输出1。<br /><code>var<br />&nbsp;&nbsp; i,x,c:longint;<br />begin<br />&nbsp;&nbsp; readln(x);<br />&nbsp;&nbsp; c:=0;<br />&nbsp;&nbsp; for i:=1 to 32 do<br />&nbsp;&nbsp; begin<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c:=c + x and 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x:=x shr 1;<br />&nbsp;&nbsp; end;<br />&nbsp;&nbsp; writeln( c and 1 );<br />end.</code><br />&nbsp;&nbsp;&nbsp;&nbsp;但这样的效率并不高，位运算的神奇之处还没有体现出来。<br />&nbsp;&nbsp;&nbsp;&nbsp;同样是判断二进制中1的个数的奇偶性，下面这段代码就强了。你能看出这个代码的原理吗？<br /><code>var<br />&nbsp;&nbsp; x:longint;<br />begin<br />&nbsp;&nbsp; readln(x);<br />&nbsp;&nbsp; x:=x xor (x shr 1);<br />&nbsp;&nbsp; x:=x xor (x shr 2);<br />&nbsp;&nbsp; x:=x xor (x shr 4);<br />&nbsp;&nbsp; x:=x xor (x shr 8);<br />&nbsp;&nbsp; x:=x xor (x shr 16);<br />&nbsp;&nbsp; writeln(x and 1);<br />end.</code><br />&nbsp;&nbsp;&nbsp;&nbsp;为了说明上面这段代码的原理，我们还是拿1314520出来说事。1314520的二进制为101000000111011011000，第一次异或操作的结果如下：
							</p>
							<p><span
									style="font-family:宋体">&nbsp;&nbsp;&nbsp;&nbsp;00000000000101000000111011011000<br />XOR&nbsp;&nbsp;0000000000010100000011101101100<br />&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;<br />&nbsp;&nbsp;&nbsp;&nbsp;00000000000111100000100110110100</span>
							</p>
							<p>&nbsp;&nbsp;&nbsp;&nbsp;得到的结果是一个新的二进制数，其中右起第i位上的数表示原数中第i和i+1位上有奇数个1还是偶数个1。比如，最右边那个0表示原数末两位有偶数个1，右起第3位上的1就表示原数的这个位置和前一个位置中有奇数个1。对这个数进行第二次异或的结果如下：
							</p>
							<p><span style="font-family:宋体">&nbsp;&nbsp;&nbsp;&nbsp;00000000000111100000100110110100<br />XOR&nbsp;&nbsp;
									000000000001111000001001101101<br />&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;<br />&nbsp;&nbsp;&nbsp;&nbsp;00000000000110011000101111011001</span>
							</p>
							<p>&nbsp;&nbsp;&nbsp;&nbsp;结果里的每个1表示原数的该位置及其前面三个位置中共有奇数个1，每个0就表示原数对应的四个位置上共偶数个1。一直做到第五次异或结束后，得到的二进制数的最末位就表示整个32位数里有多少个1，这就是我们最终想要的答案。
							</p>
							<p><strong>计算二进制中的1的个数</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;同样假设x是一个32位整数。经过下面五次赋值后，x的值就是原数的二进制表示中数字1的个数。比如，初始时x为1314520（网友抓狂：能不能换一个数啊），那么最后x就变成了9，它表示1314520的二进制中有9个1。<br /><code>x := (x and $55555555) + ((x shr 1) and $55555555); <br />x := (x and $33333333) + ((x shr 2) and $33333333); <br />x := (x and $0F0F0F0F) + ((x shr 4) and $0F0F0F0F); <br />x := (x and $00FF00FF) + ((x shr 8) and $00FF00FF); <br />x := (x and $0000FFFF) + ((x shr 16) and $0000FFFF); </code><br />&nbsp;&nbsp;&nbsp;&nbsp;为了便于解说，我们下面仅说明这个程序是如何对一个8位整数进行处理的。我们拿数字211（我们班某MM的生日）来开刀。211的二进制为11010011。
							</p>
							<p><span style="font-family:宋体">+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+<br />|
									1 | 1 | 0 | 1 | 0 | 0 | 1 | 1 |&nbsp;&nbsp;
									&lt;&#8212;原数<br />+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+&#8212;+<br />|&nbsp;&nbsp;1
									0&nbsp;&nbsp;|&nbsp;&nbsp;0 1&nbsp;&nbsp;|&nbsp;&nbsp;0 0&nbsp;&nbsp;|&nbsp;&nbsp;1
									0&nbsp;&nbsp;|&nbsp;&nbsp;
									&lt;&#8212;第一次运算后<br />+&#8212;&#8212;-+&#8212;&#8212;-+&#8212;&#8212;-+&#8212;&#8212;-+<br />|&nbsp;&nbsp;&nbsp;&nbsp;0
									0 1 1&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;0 0 1
									0&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
									&lt;&#8212;第二次运算后<br />+&#8212;&#8212;&#8212;&#8212;&#8212;+&#8212;&#8212;&#8212;&#8212;&#8212;+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0
									0 0 0 0 1 0 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
									&lt;&#8212;第三次运算后，得数为5<br />+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-+</span>
							</p>
							<p>&nbsp;&nbsp;&nbsp;&nbsp;整个程序是一个分治的思想。第一次我们把每相邻的两位加起来，得到每两位里1的个数，比如前两位10就表示原数的前两位有2个1。第二次我们继续两两相加，10+01=11，00+10=10，得到的结果是00110010，它表示原数前4位有3个1，末4位有2个1。最后一次我们把0011和0010加起来，得到的就是整个二进制中1的个数。程序中巧妙地使用取位和右移，比如第二行中$33333333的二进制为00110011001100&#8230;.，用它和x做and运算就相当于以2为单位间隔取数。shr的作用就是让加法运算的相同数位对齐。
							</p>
							<p><strong>二分查找32位整数的前导0个数</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;这里用的C语言，我直接Copy的Hacker&#39;s
								Delight上的代码。这段代码写成C要好看些，写成Pascal的话会出现很多begin和end，搞得代码很难看。程序思想是二分查找，应该很简单，我就不细说了。<br /><code>int nlz(unsigned x)<br />{<br />&nbsp;&nbsp; int n;</p>
<p>&nbsp;&nbsp; if (x == 0) return(32);<br />&nbsp;&nbsp; n = 1;<br />&nbsp;&nbsp; if ((x &gt;&gt; 16) == 0) {n = n +16; x = x &lt;&lt;16;}<br />&nbsp;&nbsp; if ((x &gt;&gt; 24) == 0) {n = n + 8; x = x &lt;&lt; 8;}<br />&nbsp;&nbsp; if ((x &gt;&gt; 28) == 0) {n = n + 4; x = x &lt;&lt; 4;}<br />&nbsp;&nbsp; if ((x &gt;&gt; 30) == 0) {n = n + 2; x = x &lt;&lt; 2;}<br />&nbsp;&nbsp; n = n - (x &gt;&gt; 31);<br />&nbsp;&nbsp; return n;<br />}</code>
							</p>
							<p><strong>只用位运算来取绝对值</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;这是一个非常有趣的问题。大家先自己想想吧，Ctrl+A显示答案。<br />&nbsp;&nbsp;&nbsp;&nbsp;<span
									style="color:#E5E5E5">答案：假设x为32位整数，则x xor (not (x shr 31) + 1) + x shr
									31的结果是x的绝对值<br />&nbsp;&nbsp;&nbsp;&nbsp;x shr 31是二进制的最高位，它用来表示x的符号。如果它为0（x为正），则not
									(x shr 31) + 1等于$00000000，异或任何数结果都不变；如果最高位为1（x为负），则not (x shr 31) +
									1等于$FFFFFFFF，x异或它相当于所有数位取反，异或完后再加一。</span></p>
							<p><strong>高低位交换</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;<a target="_blank"
									href="http://www.vijos.cn/Problem_Show.asp?id=1201">这个题</a>实际上是我出的，做为学校内部NOIp模拟赛的第一题。题目是这样：<br />
							<blockquote>
								&nbsp;&nbsp;&nbsp;&nbsp;给出一个小于2^32的正整数。这个数可以用一个32位的二进制数表示（不足32位用0补足）。我们称这个二进制数的前16位为“高位”，后16位为“低位”。将它的高低位交换，我们可以得到一个新的数。试问这个新的数是多少（用十进制表示）。<br />　　例如，数1314520用二进制表示为0000
								0000 0001 0100 0000 1110 1101 1000（添加了11个前导0补足为32位），其中前16位为高位，即0000 0000 0001
								0100；后16位为低位，即0000 1110 1101 1000。将它的高低位进行交换，我们得到了一个新的二进制数0000 1110 1101 1000 0000 0000
								0001 0100。它即是十进制的249036820。</p>
							</blockquote>
							<p>&nbsp;&nbsp;&nbsp;&nbsp;当时几乎没有人想到用一句位操作来代替冗长的程序。使用位运算的话两句话就完了。<br /><code>var<br />&nbsp;&nbsp; n:dword;<br />begin<br />&nbsp;&nbsp; readln( n );<br />&nbsp;&nbsp; writeln( (n shr 16) o&#114; (n&nbsp;&nbsp;shl 16) );<br />end.</code><br />&nbsp;&nbsp;&nbsp;&nbsp;而事实上，Pascal有一个系统函数swap直接就可以用。
							</p>
							<p><strong>二进制逆序</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;下面的程序读入一个32位整数并输</p>
						</div><!-- .entry-content -->

						<footer class="entry-footer">
							<div class="entry-meta">
								<span class="posted-on"><a href="http://www.matrix67.com/blog/archives/264"
										rel="bookmark"><time class="entry-date published"
											datetime="2007-07-24T02:42:13+00:00">2007 年 7 月 24 日</time></a></span> / <a
									href="http://www.matrix67.com/blog/archives/tag/c%e8%af%ad%e8%a8%80"
									rel="tag">C语言</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/pascal%e8%af%ad%e8%a8%80"
									rel="tag">Pascal语言</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e4%ba%8c%e8%bf%9b%e5%88%b6"
									rel="tag">二进制</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e4%bb%a3%e7%a0%81"
									rel="tag">代码</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e4%bd%8d%e8%bf%90%e7%ae%97"
									rel="tag">位运算</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e5%88%86%e6%b2%bb"
									rel="tag">分治</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e7%ae%97%e6%b3%95"
									rel="tag">算法</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e8%af%81%e6%98%8e"
									rel="tag">证明</a>, <a
									href="http://www.matrix67.com/blog/archives/tag/%e8%b6%a3%e9%a2%98" rel="tag">趣题</a>
							</div><!-- .entry-meta -->

						</footer><!-- .entry-footer -->
					</article><!-- #post-## -->
					<div id="rss"><a href="http://www.matrix67.com/blog/feed" target="_blank">&#59392;</a></div>
					<!--php matrix67_post_nav(); -->
				</main><!-- #main -->
			</div><!-- #primary -->

			<div id="secondary" class="widget-area" role="complementary">

			</div><!-- #secondary -->

		</div><!-- #content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
			<div class="site-info">
				Powered by <a href="http://wordpress.org/" target="_blank">WordPress</a>
				<span class="sep"> | </span>
				Designed by <a href="http://localhost-8080.com" rel="designer" target="_blank">♥ Localhost</a>
				<span class="sep"> | </span>
				Creative Commons <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW"
					target="_blank">BY-NC-SA</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<div style="display:none">
		<script src="http://s44.cnzz.com/stat.php?id=349609&amp;web_id=349609&amp;show=pic" language="JavaScript"
			charset="gb2312" type="text/javascript">
			</script>
	</div>
	<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
	</script>
	<script type="text/javascript">
		_uacct = "UA-1093817-1";
		urchinTracker();
	</script>

	<script type='text/javascript'
		src='http://www.matrix67.com/blog/wp-content/plugins/akismet/_inc/form.js?ver=3.1.11'></script>
	<script type='text/javascript'
		src='http://www.matrix67.com/blog/wp-content/themes/matrix67/js/navigation.js?ver=20120206'></script>
	<script type='text/javascript'
		src='http://www.matrix67.com/blog/wp-content/themes/matrix67/js/skip-link-focus-fix.js?ver=20130115'></script>
	<script type='text/javascript'
		src='http://www.matrix67.com/blog/wp-includes/js/comment-reply.min.js?ver=4.6.23'></script>
	<script type='text/javascript'
		src='http://www.matrix67.com/blog/wp-includes/js/wp-embed.min.js?ver=4.6.23'></script>

</body>

</html>
<!-- Dynamic page generated in 0.201 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2022-06-17 21:58:10 -->

<!-- super cache -->